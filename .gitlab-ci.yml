include: 'https://raw.githubusercontent.com/kinhnv/Platform.Common/main/pipeline/.prepare-ssh.yml'

variables:
  VERSION: "$CI_PIPELINE_ID"
  ASPNETCORE_ENVIRONMENT: "Production"

stages:
  - build
  - test
  - deploy

.build_tags:
  tags:
    - "shell"

.deploy_tags:
  tags:
    - "shell"

build:
  stage: build
  extends:
    - .build_tags
  only:
    - main
  before_script:
    - sed -i "s/pre-build-params_registry/$REGISTRY/g" ./**/Dockerfile
  script:
    - docker build -t $REGISTRY/common.api-gateway:${VERSION} ${CI_PROJECT_DIR} -f ${CI_PROJECT_DIR}/ApiGateway/Dockerfile
    - docker push $REGISTRY/common.api-gateway:${VERSION}
    - docker image rm $REGISTRY/common.api-gateway:${VERSION}

test:
  stage: test
  extends:
    - .build_tags
  only:
    - main
  needs: [build]
  script:
    - echo "test"
        
deploy:
  stage: deploy
  extends:
    - .deploy_tags
    - .prepare_ssh
  only:
    - main
  needs: [test]
  script:
    - git clone $GITOPS_URL 
    - cd gitops
    - yq eval ".servers.apiGateway.tag = \"${VERSION}\"" -i ./common/values.yaml
    - git add ./common/values.yaml
    - git commit -m "change to version $VERSION"
    - git push
    - cd .. && rm -rf gitops
    - git remote set-url origin $GITHUB_URL
    - >
      if [ `git branch --list main` ]; then
        echo "push to existing branch"; 
        git push -u origin HEAD:main;
      else
        echo "create new branch";
        git checkout -b main; 
        git push -u origin main;
      fi